# Discord音声再生の最適化とチューニング

## 1. 高CPU負荷の解消（ゼロ・コンバージョン再生）

**問題:**
以前は、Discordでの音声再生中にボットが高いCPU使用率を示し、フリーズすることがありました。
これは、シングルスレッドのElectronメインプロセス上で、重い音声リサンプリング処理（48kHzステレオ ⇔ 16kHzモノラル変換など）やフォーマット変換をJavaScriptやFFmpegで行っていたことが原因でした。

**解決策: 「ゼロ・コンバージョン（無変換）」パイプライン**
再生時のアプリ内音声処理を排除し、パイプラインを最適化しました。

1.  **Voicevoxの設定変更**:
    *   Voicevoxに対して、**Discordのネイティブ形式（サンプリングレート48kHz、ステレオ）で直接音声を出力する**ように設定しました。
    *   ファイル: `src/main/voice/voicevoxProvider.ts`
    *   設定: `audioQuery.outputSamplingRate = 48000;`, `audioQuery.outputStereo = true;`

2.  **Discord音声処理の変更**:
    *   CPU負荷の高かったJavaScriptによるリサンプルループ処理とFFmpegプロセスを削除しました。
    *   `playAudio` メソッドは、WAVヘッダー（44バイト）をスキップし、**Raw PCMデータ**をそのままDiscordへストリーミングするように簡素化されました。
    *   ファイル: `src/main/discord/discordVoice.ts`
    *   メソッド: `playAudio`

**結果:**
音声データはVoicevoxからDiscordへ、実質的な処理オーバーヘッドなしで流れるようになり、フリーズやCPUスパイクが解消されました。

---

## 2. 会話の「間」の調整（再生遅延）

**問題:**
文章の区切りや発話の終わりに、少し長い「間」が空くことがあります。

**原因:**
ボットが自分の声（エコー）をマイクで拾ってしまい、それに対してまた返事をしてしまう「無限ループ」を防ぐため、再生終了後に再び聞き取りを開始するまで、安全のための待機時間（ディレイ）を設けています。

**調整方法:**
この待機時間は `src/main/discord/discordVoice.ts` で調整可能です。

```typescript
// src/main/discord/discordVoice.ts

async playAudio(wavBuffer: Buffer): Promise<void> {
    // ... (再生ロジック) ...

    // 再生完了を待つ
    await new Promise<void>((resolve) => { ... });

    // ▼ ここが「間」の設定です ▼
    // エコー防止のため、聞き取り再開前に少し待機する
    await new Promise<void>((resolve) => setTimeout(resolve, 500)); 
}
```

*   **現在の値:** `500` (ミリ秒 = 0.5秒)
*   **会話のテンポを速くする:** この値を小さくします（例: `200` や `100`）。
    *   *リスク:* 値を小さくしすぎると、ボットが自分の声の残響をユーザーの声として誤認識し、無限ループに陥る可能性があります。
*   **会話のテンポを遅くする:** この値を大きくします。

**注意:**
文章の分割ロジック（`streamingTTSController.ts` での区切り文字など）を変更して分割を細かくした場合、この遅延が「各チャンク（断片）の再生後」に毎回発生するため、話し方が細切れになり、不自然な間が頻発する原因になることがあります。
